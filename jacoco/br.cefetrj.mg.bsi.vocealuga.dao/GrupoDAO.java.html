<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GrupoDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vocealuga</a> &gt; <a href="index.source.html" class="el_package">br.cefetrj.mg.bsi.vocealuga.dao</a> &gt; <span class="el_source">GrupoDAO.java</span></div><h1>GrupoDAO.java</h1><pre class="source lang-java linenums">package br.cefetrj.mg.bsi.vocealuga.dao;

import static br.cefetrj.mg.bsi.vocealuga.utils.MessageUtils.getDeleteErrorMessage;
import static br.cefetrj.mg.bsi.vocealuga.utils.MessageUtils.getDeleteSuccessMessage;
import static br.cefetrj.mg.bsi.vocealuga.utils.MessageUtils.getSaveErrorMessage;
import static br.cefetrj.mg.bsi.vocealuga.utils.MessageUtils.getSaveSuccessMessage;
import static br.cefetrj.mg.bsi.vocealuga.utils.MessageUtils.getUpdateErrorMessage;
import static br.cefetrj.mg.bsi.vocealuga.utils.MessageUtils.getUpdateSuccessMessage;
import static br.cefetrj.mg.bsi.vocealuga.utils.Utils.*;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.List;

//Import log4j classes.
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import br.cefetrj.mg.bsi.vocealuga.config.ConnectionFactory;
import br.cefetrj.mg.bsi.vocealuga.model.Grupo;
public class GrupoDAO implements DAO&lt;Grupo&gt;{

<span class="fc" id="L28">	final static Logger logger = LogManager.getLogger(GrupoDAO.class);</span>
<span class="fc" id="L29">	private ConnectionFactory factory =  null;</span>

<span class="fc" id="L31">	public GrupoDAO() {</span>
<span class="fc" id="L32">		this.factory = ConnectionFactory.getInstance();</span>
<span class="fc" id="L33">	}</span>

	@Override
	public Grupo save(Grupo o) throws Exception  {
		// TODO Auto-generated method stub
<span class="fc" id="L38">		Connection conn = this.factory.getConn();</span>
<span class="fc" id="L39">		String sql = &quot;INSERT INTO grupos(nome, created_at) VALUES(?,?)&quot;;</span>
<span class="fc" id="L40">		PreparedStatement pst = null;</span>
		try {
<span class="fc" id="L42">			conn.setAutoCommit(false);</span>
<span class="fc" id="L43">			pst = conn.prepareStatement(sql);</span>
<span class="fc" id="L44">			pst.setString(1, o.getNome());</span>
<span class="fc" id="L45">			pst.setTimestamp(2,converterLocalDateTimeToTimestamp(LocalDateTime.now(ZoneId.of(&quot;America/Sao_Paulo&quot;))));</span>
<span class="fc" id="L46">			pst.executeUpdate();</span>
<span class="fc" id="L47">			conn.commit();</span>
<span class="fc" id="L48">			pst.close();</span>
<span class="fc" id="L49">			int id = this.getLastId();</span>
<span class="fc" id="L50">			o  =  this.find(id);</span>
<span class="fc" id="L51">			logger.info(getSaveSuccessMessage(&quot;grupo &quot;+o.getNome()));</span>
<span class="fc" id="L52">			return o;</span>
<span class="fc" id="L53">		} catch (Exception e) {</span>
			// TODO: handle exception
<span class="fc" id="L55">			conn.rollback();</span>
<span class="fc" id="L56">			String errorMsg = getSaveErrorMessage(&quot;grupo&quot;,e.getMessage());</span>
<span class="fc" id="L57">			logger.error(errorMsg);</span>
<span class="fc" id="L58">			throw new Exception(errorMsg);</span>
		}



	}



	@Override
	public Grupo update(Grupo o) throws Exception{
		// TODO Auto-generated method stub
<span class="fc" id="L70">		String sql = &quot;UPDATE grupos SET nome = ?, updated_at = ? WHERE id = ?&quot;;</span>
<span class="fc" id="L71">		Connection conn = null;</span>
<span class="fc" id="L72">		PreparedStatement pst = null;</span>
		try {
<span class="fc" id="L74">			conn = this.factory.getConn();</span>
<span class="fc" id="L75">			conn.setAutoCommit(false);</span>
<span class="fc" id="L76">			Grupo oldGrupo  = this.find(o.getId());</span>
<span class="fc" id="L77">			pst = conn.prepareStatement(sql);</span>
<span class="fc" id="L78">			pst.setString(1,o.getNome());</span>
<span class="fc" id="L79">			pst.setTimestamp(2, converterLocalDateTimeToTimestamp(LocalDateTime.now(ZoneId.of(&quot;America/Sao_Paulo&quot;))));</span>
<span class="fc" id="L80">			pst.setInt(3, oldGrupo.getId());</span>
<span class="fc" id="L81">			pst.executeUpdate();</span>
<span class="fc" id="L82">			conn.commit();</span>
<span class="fc" id="L83">			pst.close();</span>
<span class="fc" id="L84">			logger.info(getUpdateSuccessMessage(&quot;grupo &quot;+o.getNome()));</span>
<span class="fc" id="L85">			return this.find(o.getId());</span>
<span class="fc" id="L86">		}catch(Exception e) {</span>
<span class="fc" id="L87">			conn.rollback();</span>
<span class="fc" id="L88">			logger.error(getUpdateErrorMessage(&quot;grupo&quot;,e.getMessage()));</span>
<span class="fc" id="L89">			throw new Exception(getUpdateErrorMessage(&quot;grupo&quot;,e.getMessage()));</span>
		}

	}

	@Override
	public Grupo delete(int id) throws Exception {
		// TODO Auto-generated method stub
<span class="fc" id="L97">		Connection conn = null;</span>
<span class="fc" id="L98">		PreparedStatement pst = null;</span>
<span class="fc" id="L99">		String sql = &quot;UPDATE grupos SET deleted_at = ? WHERE id = ?&quot;;</span>
		try {
<span class="fc" id="L101">			conn = this.factory.getConn();</span>
<span class="fc" id="L102">			conn.setAutoCommit(false);</span>
<span class="fc" id="L103">			pst = conn.prepareStatement(sql);</span>
<span class="fc" id="L104">			pst.setTimestamp(1,converterLocalDateTimeToTimestamp(LocalDateTime.now(ZoneId.of(&quot;America/Sao_Paulo&quot;))));</span>
<span class="fc" id="L105">			pst.setInt(2, id);</span>
<span class="fc" id="L106">			pst.executeUpdate();</span>
<span class="fc" id="L107">			pst.close();</span>
<span class="fc" id="L108">			conn.commit();</span>
<span class="fc" id="L109">			logger.info(getDeleteSuccessMessage(&quot;grupo&quot;));</span>
<span class="fc" id="L110">			return this.find(id);</span>
<span class="fc" id="L111">		}catch(Exception e) {</span>
<span class="fc" id="L112">			conn.rollback();</span>
<span class="fc" id="L113">			logger.error(getDeleteErrorMessage(&quot;grupo&quot;, e.getMessage()));</span>
<span class="fc" id="L114">			throw new Exception(getDeleteErrorMessage(&quot;grupo&quot;, e.getMessage()));</span>
		}


	}

	@Override
	public List&lt;Grupo&gt; findAll() throws Exception {
		// TODO Auto-generated method stub
<span class="fc" id="L123">		String sql = &quot;SELECT * FROM grupos&quot;;</span>
<span class="fc" id="L124">		Connection conn = null;</span>
<span class="fc" id="L125">		PreparedStatement pst = null;</span>
<span class="fc" id="L126">		ResultSet rs = null;</span>
<span class="fc" id="L127">		List&lt;Grupo&gt; grupos = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L129">			conn = this.factory.getConn();</span>
<span class="fc" id="L130">			pst = conn.prepareStatement(sql);</span>
<span class="fc" id="L131">			rs = pst.executeQuery();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L133">				Grupo g = new Grupo();</span>
<span class="fc" id="L134">				g.setId(rs.getInt(&quot;id&quot;));</span>
<span class="fc" id="L135">				g.setNome(rs.getString(&quot;nome&quot;));</span>
<span class="fc" id="L136">				LocalDateTime date = null;</span>
<span class="fc" id="L137">				date = rs.getTimestamp(&quot;created_at&quot;).toLocalDateTime();</span>
<span class="fc" id="L138">				g.setCreatedAt(date);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">				if(rs.getTimestamp(&quot;updated_at&quot;) != null) {</span>
<span class="fc" id="L140">					date = rs.getTimestamp(&quot;updated_at&quot;).toLocalDateTime();</span>
<span class="fc" id="L141">					g.setUpdatedAt(date);</span>
				}
<span class="fc bfc" id="L143" title="All 2 branches covered.">				if(rs.getTimestamp(&quot;deleted_at&quot;) != null) {</span>
<span class="fc" id="L144">					date = rs.getTimestamp(&quot;deleted_at&quot;).toLocalDateTime();</span>
<span class="fc" id="L145">					g.setDeletedAt(date);</span>
				}
<span class="fc" id="L147">				grupos.add(g);</span>
<span class="fc" id="L148">			}</span>
<span class="fc" id="L149">			rs.close();</span>
<span class="fc" id="L150">			pst.close();</span>

<span class="nc" id="L152">		}catch(SQLException e) {</span>
<span class="nc" id="L153">			logger.error(&quot;findAll:&quot;+e.getMessage());</span>
<span class="nc" id="L154">			throw new Exception(e.getMessage());</span>
<span class="fc" id="L155">		}</span>
<span class="fc" id="L156">		return grupos;</span>


	}

	@Override
	public Grupo find(int id) throws Exception {
		// TODO Auto-generated method stub
<span class="fc" id="L164">		Connection conn = this.factory.getConn();</span>
<span class="fc" id="L165">		Grupo g = null;</span>
<span class="fc" id="L166">		String sql =&quot;SELECT * FROM grupos WHERE id = ?&quot;;</span>
		try {
<span class="fc" id="L168">			PreparedStatement pst = conn.prepareStatement(sql);</span>
<span class="fc" id="L169">			pst.setInt(1,id);</span>

<span class="fc" id="L171">			ResultSet rs = pst.executeQuery();</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">			if(!rs.next())</span>
<span class="fc" id="L173">				throw new Exception(String.format(&quot;Grupo com id %d não foi encontrado&quot;,id));</span>
			else{
<span class="fc" id="L175">				g = new Grupo();</span>
<span class="fc" id="L176">				g.setId(rs.getInt(&quot;id&quot;));</span>
<span class="fc" id="L177">				g.setNome(rs.getString(&quot;nome&quot;));</span>
<span class="fc" id="L178">				LocalDateTime date = null;</span>
<span class="fc" id="L179">				date = rs.getTimestamp(&quot;created_at&quot;).toLocalDateTime();</span>
<span class="fc" id="L180">				g.setCreatedAt(date);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">				if(rs.getTimestamp(&quot;updated_at&quot;) != null) {</span>
<span class="fc" id="L182">					date = rs.getTimestamp(&quot;updated_at&quot;).toLocalDateTime();</span>
<span class="fc" id="L183">					g.setUpdatedAt(date);</span>
				}
<span class="fc bfc" id="L185" title="All 2 branches covered.">				if(rs.getTimestamp(&quot;deleted_at&quot;) != null) {</span>
<span class="fc" id="L186">					date = rs.getTimestamp(&quot;deleted_at&quot;).toLocalDateTime();</span>
<span class="fc" id="L187">					g.setDeletedAt(date);</span>
				}


			}
<span class="fc" id="L192">			rs.close();</span>
<span class="fc" id="L193">			pst.close();</span>
<span class="fc" id="L194">			return g;</span>
<span class="fc" id="L195">		} catch (Exception e) {</span>
			// TODO: handle exception
<span class="fc" id="L197">			logger.error(&quot;findById:&quot;+e.getMessage());</span>
<span class="fc" id="L198">			throw new Exception(e.getMessage());</span>
		}



	}


	@Override
	public int getLastId() throws Exception {
		// TODO Auto-generated method stub
<span class="fc" id="L209">		int id = 0;</span>
<span class="fc" id="L210">		String sql = &quot;SELECT max(id) as id FROM grupos ;&quot;;</span>
<span class="fc" id="L211">		PreparedStatement pst = null;</span>
<span class="fc" id="L212">		ResultSet rs = null;</span>
<span class="fc" id="L213">		Connection conn = null;</span>
		try {
<span class="fc" id="L215">			conn = this.factory.getConn();</span>
<span class="fc" id="L216">			pst = conn.prepareStatement(sql);</span>
<span class="fc" id="L217">			rs = pst.executeQuery();</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">			if(rs.next())</span>
<span class="fc" id="L219">				id = rs.getInt(&quot;id&quot;);</span>
<span class="fc" id="L220">			rs.close();</span>
<span class="fc" id="L221">			pst.close();</span>
<span class="fc" id="L222">			return id;</span>
<span class="nc" id="L223">		} catch (SQLException e) {</span>
			// TODO: handle exception
<span class="nc" id="L225">			logger.error(e.getMessage());</span>
<span class="nc" id="L226">			throw new Exception(e.getMessage());</span>
		}

	}




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>